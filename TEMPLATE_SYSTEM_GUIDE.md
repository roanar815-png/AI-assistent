# Руководство по системе шаблонов документов

## Обзор

Система шаблонов документов позволяет загружать собственные шаблоны документов и автоматически заполнять их данными из чата с ассистентом.

## Возможности

### 1. Загрузка шаблонов
- Поддержка форматов: `.docx` (Word) и `.txt` (текстовые)
- Автоматическое создание метаданных
- Уникальные ID для каждого шаблона

### 2. Автоматическое заполнение
- Извлечение данных пользователя из чата
- Подстановка плейсхолдеров
- Создание готовых документов

### 3. Интеграция с чатом
- Автоматическое предложение создания документов
- Анализ ключевых слов в сообщениях
- Контекстное понимание намерений

## API Endpoints

### Загрузка шаблона
```http
POST /api/documents/templates/upload
Content-Type: multipart/form-data

file: [файл шаблона]
template_name: "Название шаблона"
description: "Описание шаблона"
```

### Список шаблонов
```http
GET /api/documents/templates/list
```

### Создание документа
```http
POST /api/documents/templates/{template_id}/generate
Content-Type: application/json

{
  "user_data": {
    "user_id": "user123",
    "full_name": "Иван Иванов",
    "email": "ivan@example.com",
    "organization": "ООО Ромашка"
  },
  "conversation_data": {
    "message": "Хочу заключить договор",
    "response": "Конечно, помогу с договором"
  }
}
```

### Создание документа из чата
```http
POST /api/chat/create-document
Content-Type: application/json

{
  "user_id": "user123",
  "template_id": "template-uuid",
  "user_data": {...},
  "conversation_data": {...}
}
```

## Плейсхолдеры

### Доступные переменные:
- `{{user_id}}` - ID пользователя
- `{{full_name}}` - ФИО
- `{{email}}` - Email
- `{{phone}}` - Телефон
- `{{organization}}` - Организация
- `{{position}}` - Должность
- `{{inn}}` - ИНН
- `{{business_type}}` - Тип бизнеса
- `{{date}}` - Текущая дата
- `{{message}}` - Сообщение пользователя
- `{{response}}` - Ответ ассистента

### Пример текстового шаблона:
```
ДОГОВОР О СОТРУДНИЧЕСТВЕ

Дата: {{date}}

Стороны:
1. {{organization}} ({{full_name}})
   Email: {{email}}
   Телефон: {{phone}}

2. Опора России

Предмет договора:
{{message}}

Подписи:
{{full_name}} _________________
Представитель Опора России _________________
```

## Веб-интерфейс

Доступен по адресу: `/static/template-manager.html`

### Функции интерфейса:
- Загрузка новых шаблонов
- Просмотр списка шаблонов
- Удаление шаблонов
- Справка по плейсхолдерам

## Автоматическое предложение документов

Ассистент автоматически предлагает создать документ, если в сообщении пользователя встречаются ключевые слова:

- "документ", "договор", "соглашение"
- "заявление", "жалоба", "протокол"
- "отчет", "справка", "свидетельство"
- "создать", "оформить", "заполнить", "подготовить"

### Пример работы:
1. Пользователь: "Мне нужно создать договор о сотрудничестве"
2. Ассистент: "Я могу создать документ на основе нашего разговора. Выберите подходящий шаблон:"
3. Система показывает доступные шаблоны
4. Пользователь выбирает шаблон
5. Создается заполненный документ

## Структура файлов

```
templates/documents/
├── README.md                    # Описание системы
├── example_contract.txt         # Пример шаблона
├── [template-id].json          # Метаданные шаблонов
└── [template-id].docx          # Файлы шаблонов

generated_documents/
└── [название]_[user_id]_[дата].docx  # Созданные документы
```

## Безопасность

- Проверка типов файлов при загрузке
- Валидация данных пользователя
- Обработка ошибок
- Логирование операций

## Расширение функциональности

### Добавление новых типов файлов:
1. Обновить `DocumentService._fill_*_template()` методы
2. Добавить поддержку в `upload_template()`
3. Обновить валидацию в API

### Новые плейсхолдеры:
1. Добавить в `fill_data` в `fill_uploaded_template()`
2. Обновить документацию
3. Добавить в веб-интерфейс

## Примеры использования

### 1. Загрузка шаблона через API
```python
import requests

files = {'file': open('template.docx', 'rb')}
data = {
    'template_name': 'Договор о сотрудничестве',
    'description': 'Стандартный договор для новых членов'
}

response = requests.post(
    'http://localhost:8000/api/documents/templates/upload',
    files=files,
    data=data
)
```

### 2. Создание документа
```python
import requests

data = {
    'user_data': {
        'user_id': 'user123',
        'full_name': 'Иван Иванов',
        'email': 'ivan@example.com',
        'organization': 'ООО Ромашка'
    },
    'conversation_data': {
        'message': 'Хочу заключить договор',
        'response': 'Помогу с договором'
    }
}

response = requests.post(
    'http://localhost:8000/api/documents/templates/template-uuid/generate',
    json=data
)
```

## Устранение неполадок

### Ошибка "Неподдерживаемый тип файла"
- Убедитесь, что файл имеет расширение .docx или .txt
- Проверьте, что файл не поврежден

### Ошибка "Шаблон не найден"
- Проверьте правильность template_id
- Убедитесь, что шаблон не был удален

### Ошибка заполнения
- Проверьте синтаксис плейсхолдеров (двойные фигурные скобки)
- Убедитесь, что все необходимые данные переданы

## Поддержка

При возникновении проблем:
1. Проверьте логи приложения
2. Убедитесь в правильности конфигурации
3. Проверьте права доступа к папкам
4. Обратитесь к документации API

