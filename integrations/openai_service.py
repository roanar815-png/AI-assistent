"""
–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å OpenAI API –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞
"""
from openai import OpenAI
from typing import List, Dict
from datetime import datetime
from config import settings
from logger_config import get_logger, log_success, log_error, log_warning
import httpx
import asyncio
from functools import lru_cache
import hashlib
import time

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–≥–µ—Ä–∞
logger = get_logger(__name__)


class OpenAIService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å OpenAI API"""
    
    def __init__(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è OpenAI/DeepSeek –∫–ª–∏–µ–Ω—Ç–∞"""
        print(f"\n[INITIALIZATION] OpenAI Service:")
        
        # –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–æ–∫ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        self.client = None
        self.async_client = None
        self.model = None
        self.response_cache = {}  # –ö—ç—à –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
        self.cache_ttl = 3600  # TTL –∫—ç—à–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (1 —á–∞—Å)
        self.connection_pool = None
        
        try:
            print(f"   [DEBUG] –ù–∞—á–∏–Ω–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é OpenAI...")
            api_key = getattr(settings, 'openai_api_key', None)
            print(f"   API Key: {'–ï–°–¢–¨' if api_key and api_key.strip() else '–ù–ï–¢'}")
            
            if not api_key or not api_key.strip():
                print(f"   [WARNING] OpenAI API –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!")
                print(f"   –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è, –Ω–æ –±–æ—Ç –ù–ï –ë–£–î–ï–¢ –æ—Ç–≤–µ—á–∞—Ç—å.")
                return
            
            print(f"   API Key start: {api_key[:20]}... (first 20 chars)")
            
            # –°–æ–∑–¥–∞–µ–º HTTP –∫–ª–∏–µ–Ω—Ç —Å —Ç–∞–π–º-–∞—É—Ç–∞–º–∏ –∏ –ø—Ä–æ–∫—Å–∏
            proxy_config = None
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–∫—Å–∏
            proxy_login = getattr(settings, 'proxy_login', None)
            proxy_password = getattr(settings, 'proxy_password', None)
            proxy_ip = getattr(settings, 'proxy_ip', None)
            proxy_port = getattr(settings, 'proxy_port', None)
            
            print(f"   [DEBUG] –ü—Ä–æ–∫—Å–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:")
            print(f"   [DEBUG]   proxy_login: {proxy_login}")
            print(f"   [DEBUG]   proxy_password: {'–ï–°–¢–¨' if proxy_password else '–ù–ï–¢'}")
            print(f"   [DEBUG]   proxy_ip: {proxy_ip}")
            print(f"   [DEBUG]   proxy_port: {proxy_port}")
            
            # –°–æ–∑–¥–∞–µ–º –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
            connection_limits = httpx.Limits(
                max_keepalive_connections=20,  # –£–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è –ø—É–ª–∞
                max_connections=50,            # –£–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è –ø—É–ª–∞
                keepalive_expiry=30.0          # –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
            )
            
            timeout_config = httpx.Timeout(
                timeout=30.0,   # –ï—â–µ –±–æ–ª—å—à–µ —É–º–µ–Ω—å—à–µ–Ω –æ–±—â–∏–π —Ç–∞–π–º-–∞—É—Ç
                connect=3.0,    # –û—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
                read=30.0,      # –£–º–µ–Ω—å—à–µ–Ω —Ç–∞–π–º-–∞—É—Ç —á—Ç–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞
                write=3.0       # –û—á–µ–Ω—å –±—ã—Å—Ç—Ä–∞—è –∑–∞–ø–∏—Å—å
            )
            
            # –°–æ–∑–¥–∞–µ–º HTTP –∫–ª–∏–µ–Ω—Ç —Å –ø—Ä–æ–∫—Å–∏, –µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
            if proxy_login and proxy_password and proxy_ip and proxy_port:
                proxy_url = f"http://{proxy_login}:{proxy_password}@{proxy_ip}:{proxy_port}"
                print(f"   [INFO] –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–∫—Å–∏: {proxy_ip}:{proxy_port}")
                
                try:
                    # –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç
                    http_client = httpx.Client(
                        timeout=timeout_config,
                        limits=connection_limits,
                        http2=False,  # –û—Ç–∫–ª—é—á–∞–µ–º HTTP2 –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –æ—à–∏–±–æ–∫
                        proxy=proxy_url
                    )
                    
                    # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
                    self.async_client = httpx.AsyncClient(
                        timeout=timeout_config,
                        limits=connection_limits,
                        http2=False,
                        proxy=proxy_url
                    )
                    
                except Exception as e:
                    print(f"   [ERROR] –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ httpx.Client —Å –ø—Ä–æ–∫—Å–∏: {e}")
                    raise
            else:
                # –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç
                http_client = httpx.Client(
                    timeout=timeout_config,
                    limits=connection_limits,
                    http2=False
                )
                
                # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç
                self.async_client = httpx.AsyncClient(
                    timeout=timeout_config,
                    limits=connection_limits,
                    http2=False
                )
            
            print(f"   [INFO] –ò—Å–ø–æ–ª—å–∑—É–µ–º OpenAI API")
            try:
                # –°–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç OpenAI —Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º HTTP –∫–ª–∏–µ–Ω—Ç–æ–º
                client_kwargs = {
                    "api_key": api_key,
                    "http_client": http_client,
                    "timeout": 90.0,  # –û–±—â–∏–π —Ç–∞–π–º-–∞—É—Ç 90 —Å–µ–∫—É–Ω–¥
                    "max_retries": 2
                }
                
                self.client = OpenAI(**client_kwargs)
                self.model = "gpt-4o-mini"  # –ë—ã—Å—Ç—Ä–∞—è –º–æ–¥–µ–ª—å OpenAI
                print(f"   [SUCCESS] OpenAI –∫–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω, –º–æ–¥–µ–ª—å: {self.model}")
            except Exception as e:
                print(f"   [ERROR] –û–®–ò–ë–ö–ê —Å–æ–∑–¥–∞–Ω–∏—è OpenAI –∫–ª–∏–µ–Ω—Ç–∞: {e}")
                print(f"   –°–µ—Ä–≤–µ—Ä –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç—É, –Ω–æ –±–æ—Ç –ù–ï –ë–£–î–ï–¢ –æ—Ç–≤–µ—á–∞—Ç—å.")
                self.client = None
                    
        except Exception as e:
            print(f"   [ERROR] –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ OpenAI Service: {e}", flush=True)
            import traceback
            traceback.print_exc()
            print(f"   –°–µ—Ä–≤–µ—Ä –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç—É, –Ω–æ –±–æ—Ç –ù–ï –ë–£–î–ï–¢ –æ—Ç–≤–µ—á–∞—Ç—å.", flush=True)
            self.client = None
        
        # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
        print(f"\n[FINAL CHECK] OpenAI Service –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞:", flush=True)
        print(f"   self.client = {self.client is not None}", flush=True)
        print(f"   self.async_client = {self.async_client is not None}", flush=True)
        print(f"   self.model = {self.model}", flush=True)
        if not self.client:
            print(f"   [WARNING] –ö–õ–ò–ï–ù–¢ –ù–ï –°–û–ó–î–ê–ù! –ë–æ—Ç –Ω–µ –±—É–¥–µ—Ç –æ—Ç–≤–µ—á–∞—Ç—å!", flush=True)
        
        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –¥–ª—è –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
        current_date = datetime.now()
        current_year = current_date.year
        current_date_str = current_date.strftime("%d.%m.%Y")
        
        # –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç - —Å–æ–∫—Ä–∞—â–µ–Ω –≤ 10 —Ä–∞–∑ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
        self.system_prompt = f"""–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç "–û–ø–æ—Ä–∞ –†–æ—Å—Å–∏–∏" –¥–ª—è –º–∞–ª–æ–≥–æ –∏ —Å—Ä–µ–¥–Ω–µ–≥–æ –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å—Å—Ç–≤–∞ (–ú–°–ü). –î–∞—Ç–∞: {current_date_str} ({current_year}).

–û–°–ù–û–í–ù–´–ï –ù–ê–ü–†–ê–í–õ–ï–ù–ò–Ø –†–ê–ë–û–¢–´:

–î–û–ö–£–ú–ï–ù–¢–û–û–ë–û–†–û–¢ –ò –ó–ê–Ø–í–ö–ò:
‚Ä¢ –ü–æ–º–æ—â—å –≤ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞—è–≤–ª–µ–Ω–∏–π, –∞–Ω–∫–µ—Ç –∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
‚Ä¢ –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –ø–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
‚Ä¢ –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–Ω–æ—Ç—ã –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

–ü–†–ê–í–û–í–´–ï –ö–û–ù–°–£–õ–¨–¢–ê–¶–ò–ò:
‚Ä¢ –†–∞–∑—ä—è—Å–Ω–µ–Ω–∏–µ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –¥–ª—è –ú–°–ü
‚Ä¢ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ª—å–≥–æ—Ç–∞—Ö, —Å—É–±—Å–∏–¥–∏—è—Ö –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–µ
‚Ä¢ –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –ø–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏ –≤–µ–¥–µ–Ω–∏—é –±–∏–∑–Ω–µ—Å–∞
‚Ä¢ –ü–æ–º–æ—â—å –≤ –ø–æ–Ω–∏–º–∞–Ω–∏–∏ –Ω–∞–ª–æ–≥–æ–≤–æ–≥–æ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞

–ê–ù–ê–õ–ò–ó –ë–ò–ó–ù–ï–°-–ü–†–û–¶–ï–°–°–û–í:
‚Ä¢ –ê–Ω–∞–ª–∏–∑ –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∏ –∏—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
‚Ä¢ –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –ø–æ —Ä–∞–∑–≤–∏—Ç–∏—é –±–∏–∑–Ω–µ—Å–∞
‚Ä¢ –ü–æ–º–æ—â—å –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
‚Ä¢ –ê–Ω–∞–ª–∏–∑ —Ä—ã–Ω–∫–∞ –∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤

–ü–û–î–î–ï–†–ñ–ö–ê –ú–°–ü:
‚Ä¢ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–≥—Ä–∞–º–º–∞—Ö –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –º–∞–ª–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞
‚Ä¢ –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –ø–æ –ø–æ–ª—É—á–µ–Ω–∏—é —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏—è
‚Ä¢ –ü–æ–º–æ—â—å –≤ –ø–æ–∏—Å–∫–µ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ –∏ –∫–ª–∏–µ–Ω—Ç–æ–≤
‚Ä¢ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã—Å—Ç–∞–≤–∫–∞—Ö –∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è—Ö

–ö–û–ù–¢–ê–ö–¢–´ –ò –†–ï–ì–ò–û–ù–ê–õ–¨–ù–ê–Ø –ü–û–î–î–ï–†–ñ–ö–ê:
‚Ä¢ –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ —Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –æ—Ç–¥–µ–ª–µ–Ω–∏–π
‚Ä¢ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–µ—Å—Ç–Ω—ã—Ö –ø—Ä–æ–≥—Ä–∞–º–º–∞—Ö –ø–æ–¥–¥–µ—Ä–∂–∫–∏
‚Ä¢ –ü–æ–º–æ—â—å –≤ –ø–æ–∏—Å–∫–µ –±–ª–∏–∂–∞–π—à–∏—Ö –æ—Ñ–∏—Å–æ–≤ "–û–ø–æ—Ä–∞ –†–æ—Å—Å–∏–∏"

–¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –ü–û–î–î–ï–†–ñ–ö–ê:
‚Ä¢ –ü–æ–º–æ—â—å –≤ —Ä–∞–±–æ—Ç–µ —Å —Ü–∏—Ñ—Ä–æ–≤—ã–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏
‚Ä¢ –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –ø–æ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤
‚Ä¢ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ü–∏—Ñ—Ä–æ–≤—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞—Ö –¥–ª—è –ú–°–ü

–ê–ù–ê–õ–ò–¢–ò–ö–ê –ò –ü–†–û–ì–ù–û–ó–´:
‚Ä¢ –ê–Ω–∞–ª–∏–∑ —Ç—Ä–µ–Ω–¥–æ–≤ –≤ —Å—Ñ–µ—Ä–µ –ú–°–ü
‚Ä¢ –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–≤–∏—Ç–∏—è —Ä—ã–Ω–∫–∞
‚Ä¢ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ
‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–∞–∑–≤–∏—Ç–∏—é –±–∏–∑–Ω–µ—Å–∞

–°–¢–ò–õ–¨ –û–ë–©–ï–ù–ò–Ø:
‚Ä¢ –î—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–æ–Ω
‚Ä¢ –ü–æ–¥—Ä–æ–±–Ω—ã–µ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
‚Ä¢ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø—Ä–∏–º–µ—Ä–æ–≤ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
‚Ä¢ –ê–¥–∞–ø—Ç–∞—Ü–∏—è —Å–ª–æ–∂–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ–¥ —É—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
‚Ä¢ –ê–∫—Ç–∏–≤–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –ø–æ–º–æ—â–∏

–í–ê–ñ–ù–´–ï –ü–†–ò–ù–¶–ò–ü–´:
‚Ä¢ –î–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π –æ—Ç–≤–µ—á–∞–π –¥—Ä—É–∂–µ–ª—é–±–Ω–æ, –ù–ï –ø—Ä–µ–¥–ª–∞–≥–∞–π —Å–æ–∑–¥–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
‚Ä¢ –ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–∞—Ö –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç—ã - –ø—Ä–µ–¥–ª–∞–≥–∞–π –≤—ã–±–æ—Ä —à–∞–±–ª–æ–Ω–∞, –ù–ï —Å–æ–∑–¥–∞–≤–∞–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
‚Ä¢ –î–∞–≤–∞–π —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–µ –æ—Ç–≤–µ—Ç—ã —Å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–º–∏ —Å–æ–≤–µ—Ç–∞–º–∏
‚Ä¢ –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–π –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø–æ–º–æ—â–∏
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –ø–æ–¥–∞—á—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
‚Ä¢ –ü—Ä–∏–≤–æ–¥–∏ –ø—Ä–∏–º–µ—Ä—ã –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —à–∞–≥–∏ –¥–µ–π—Å—Ç–≤–∏–π

–ü–†–ò–ú–ï–†–´ –•–û–†–û–®–ò–• –û–¢–í–ï–¢–û–í:
- –ü—Ä–∏ –≤–æ–ø—Ä–æ—Å–µ –æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ò–ü: –ø–æ–¥—Ä–æ–±–Ω–æ –æ–±—ä—è—Å–Ω–∏ —ç—Ç–∞–ø—ã, –¥–æ–∫—É–º–µ–Ω—Ç—ã, —Å—Ä–æ–∫–∏, —Å—Ç–æ–∏–º–æ—Å—Ç—å
- –ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –æ –ª—å–≥–æ—Ç–∞—Ö: –ø–µ—Ä–µ—á–∏—Å–ª–∏ –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ª—å–≥–æ—Ç—ã —Å —É—Å–ª–æ–≤–∏—è–º–∏ –ø–æ–ª—É—á–µ–Ω–∏—è
- –ü—Ä–∏ –≤–æ–ø—Ä–æ—Å–µ –æ —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–∏: –æ–ø–∏—à–∏ –≤—Å–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏
- –ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö: –ø—Ä–µ–¥–ª–æ–∂–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ —à–∞–±–ª–æ–Ω—ã —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º –∏—Ö –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è

–ü–æ–º–Ω–∏: —Ç–≤–æ—è —Ü–µ–ª—å - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–º–æ—á—å –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—é –≤ —Ä–∞–∑–≤–∏—Ç–∏–∏ –µ–≥–æ –±–∏–∑–Ω–µ—Å–∞!"""
    
    def _get_cache_key(self, message: str, conversation_history: List[Dict] = None) -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–ª—é—á –∫—ç—à–∞ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è"""
        # –°–æ–∑–¥–∞–µ–º —Ö—ç—à –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 3 —Å–æ–æ–±—â–µ–Ω–∏–π –∏—Å—Ç–æ—Ä–∏–∏
        history_text = ""
        if conversation_history:
            recent_history = conversation_history[-3:]  # –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 —Å–æ–æ–±—â–µ–Ω–∏—è
            history_text = " ".join([msg.get("content", "") for msg in recent_history])
        
        cache_input = f"{message.lower().strip()}:{history_text}"
        return hashlib.md5(cache_input.encode()).hexdigest()
    
    def _is_cache_valid(self, cache_entry: dict) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∫—ç—à–∞"""
        if not cache_entry:
            return False
        return time.time() - cache_entry.get("timestamp", 0) < self.cache_ttl
    
    def _get_cached_response(self, cache_key: str) -> str:
        """–ü–æ–ª—É—á–∞–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç"""
        cache_entry = self.response_cache.get(cache_key)
        if cache_entry and self._is_cache_valid(cache_entry):
            logger.info(f"üöÄ –ö—ç—à HIT –¥–ª—è –∫–ª—é—á–∞: {cache_key[:8]}...")
            return cache_entry["response"]
        return None
    
    def _cache_response(self, cache_key: str, response: str):
        """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—Ç–≤–µ—Ç –≤ –∫—ç—à"""
        self.response_cache[cache_key] = {
            "response": response,
            "timestamp": time.time()
        }
        logger.debug(f"üíæ –ö—ç—à SAVE –¥–ª—è –∫–ª—é—á–∞: {cache_key[:8]}...")
    
    def _cleanup_cache(self):
        """–û—á–∏—â–∞–µ—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –∑–∞–ø–∏—Å–∏ –∫—ç—à–∞"""
        current_time = time.time()
        expired_keys = [
            key for key, entry in self.response_cache.items()
            if current_time - entry.get("timestamp", 0) > self.cache_ttl
        ]
        for key in expired_keys:
            del self.response_cache[key]
        if expired_keys:
            logger.debug(f"üßπ –û—á–∏—â–µ–Ω–æ {len(expired_keys)} —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∑–∞–ø–∏—Å–µ–π –∫—ç—à–∞")
    
    def chat(self, message: str, conversation_history: List[Dict] = None) -> str:
        """
        –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç –∏ –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
        
        Args:
            message: –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            conversation_history: –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞
        
        Returns:
            –û—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
        """
        logger.info("ü§ñ –í—ã–∑–æ–≤ OpenAI/DeepSeek API –¥–ª—è —á–∞—Ç–∞")
        logger.debug(f"   Model: {self.model}")
        logger.debug(f"   Client configured: {'YES' if self.client else 'NO'}")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –∫–ª–∏–µ–Ω—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω
        if not self.client:
            log_error(logger, "OpenAI –∫–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω! API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
            return "–ò–∑–≤–∏–Ω–∏—Ç–µ, OpenAI/DeepSeek API –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Å–µ—Ä–≤–µ—Ä–∞."
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
        cache_key = self._get_cache_key(message, conversation_history)
        cached_response = self._get_cached_response(cache_key)
        if cached_response:
            return cached_response
        
        # –û—á–∏—â–∞–µ–º —É—Å—Ç–∞—Ä–µ–≤—à–∏–π –∫—ç—à
        self._cleanup_cache()
        
        try:
            history_len = len(conversation_history) if conversation_history else 0
            logger.info(f"   Message length: {len(message)} chars")
            logger.info(f"   History: {history_len} messages")
            
            messages = [{"role": "system", "content": self.system_prompt}]
            
            if conversation_history:
                # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è - —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 —Å–æ–æ–±—â–µ–Ω–∏—è
                recent_history = conversation_history[-3:]  # –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 —Å–æ–æ–±—â–µ–Ω–∏—è
                messages.extend(recent_history)
            
            messages.append({"role": "user", "content": message})
            
            logger.info(f"   üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ {len(messages)} —Å–æ–æ–±—â–µ–Ω–∏–π –∫ API...")
            logger.debug(f"   –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: temperature=0.7, max_tokens=2000")
            
            start_time = time.time()
            
            response = self.client.chat.completions.create(
                model=self.model,
                messages=messages,
                temperature=0.5,  # –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å
                max_tokens=4000,  # –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è –ø–æ–ª–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
                timeout=60.0      # –£–≤–µ–ª–∏—á–µ–Ω —Ç–∞–π–º-–∞—É—Ç –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
            )
            
            elapsed_time = time.time() - start_time
            
            result = response.choices[0].message.content
            log_success(logger, f"API –æ—Ç–≤–µ—Ç–∏–ª –∑–∞ {elapsed_time:.2f}s", 
                       response_length=len(result) if result else 0,
                       model=self.model)
            logger.debug(f"   Preview: {result[:100] if result else 'EMPTY'}...")
            
            # –ö—ç—à–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
            if len(message) < 100 and len(result) < 500:
                self._cache_response(cache_key, result)
            
            return result
            
        except httpx.TimeoutException as e:
            log_error(logger, "‚è±Ô∏è –¢–∞–π–º-–∞—É—Ç –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ API", error=e, model=self.model)
            return "–ò–∑–≤–∏–Ω–∏—Ç–µ, API –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –≤–æ–≤—Ä–µ–º—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ —É–ø—Ä–æ—Å—Ç–∏—Ç–µ –∑–∞–ø—Ä–æ—Å."
        except Exception as e:
            log_error(logger, "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ OpenAI API", 
                     error=e, model=self.model)
            return f"–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
    
    async def chat_async(self, message: str, conversation_history: List[Dict] = None) -> str:
        """
        –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
        
        Args:
            message: –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            conversation_history: –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞
        
        Returns:
            –û—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
        """
        logger.info("ü§ñ –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≤—ã–∑–æ–≤ OpenAI/DeepSeek API –¥–ª—è —á–∞—Ç–∞")
        logger.debug(f"   Model: {self.model}")
        logger.debug(f"   Async Client configured: {'YES' if self.async_client else 'NO'}")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω
        if not self.async_client:
            log_error(logger, "OpenAI –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω! API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
            return "–ò–∑–≤–∏–Ω–∏—Ç–µ, OpenAI/DeepSeek API –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Å–µ—Ä–≤–µ—Ä–∞."
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
        cache_key = self._get_cache_key(message, conversation_history)
        cached_response = self._get_cached_response(cache_key)
        if cached_response:
            return cached_response
        
        # –û—á–∏—â–∞–µ–º —É—Å—Ç–∞—Ä–µ–≤—à–∏–π –∫—ç—à
        self._cleanup_cache()
        
        try:
            history_len = len(conversation_history) if conversation_history else 0
            logger.info(f"   Message length: {len(message)} chars")
            logger.info(f"   History: {history_len} messages")
            
            messages = [{"role": "system", "content": self.system_prompt}]
            
            if conversation_history:
                # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è - —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 —Å–æ–æ–±—â–µ–Ω–∏—è
                recent_history = conversation_history[-3:]  # –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 —Å–æ–æ–±—â–µ–Ω–∏—è
                messages.extend(recent_history)
            
            messages.append({"role": "user", "content": message})
            
            logger.info(f"   üì§ –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ {len(messages)} —Å–æ–æ–±—â–µ–Ω–∏–π –∫ API...")
            logger.debug(f"   –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: temperature=0.7, max_tokens=2000")
            
            start_time = time.time()
            
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç
            response = await self.async_client.post(
                "https://api.openai.com/v1/chat/completions",
                headers={
                    "Authorization": f"Bearer {settings.openai_api_key}",
                    "Content-Type": "application/json"
                },
                json={
                    "model": self.model,
                    "messages": messages,
                    "temperature": 0.5,
                    "max_tokens": 600
                }
            )
            
            elapsed_time = time.time() - start_time
            
            if response.status_code == 200:
                result_data = response.json()
                result = result_data["choices"][0]["message"]["content"]
                
                log_success(logger, f"–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π API –æ—Ç–≤–µ—Ç–∏–ª –∑–∞ {elapsed_time:.2f}s", 
                           response_length=len(result) if result else 0,
                           model=self.model)
                logger.debug(f"   Preview: {result[:100] if result else 'EMPTY'}...")
                
                # –ö—ç—à–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
                if len(message) < 100 and len(result) < 500:
                    self._cache_response(cache_key, result)
                
                return result
            else:
                log_error(logger, f"–û—à–∏–±–∫–∞ API: {response.status_code}", 
                         response_text=response.text)
                return "–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ API."
            
        except httpx.TimeoutException as e:
            log_error(logger, "‚è±Ô∏è –¢–∞–π–º-–∞—É—Ç –ø—Ä–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ API", error=e, model=self.model)
            return "–ò–∑–≤–∏–Ω–∏—Ç–µ, API –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –≤–æ–≤—Ä–µ–º—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ —É–ø—Ä–æ—Å—Ç–∏—Ç–µ –∑–∞–ø—Ä–æ—Å."
        except Exception as e:
            log_error(logger, "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ OpenAI API", 
                     error=e, model=self.model)
            return f"–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
    
    async def process_multiple_requests(self, requests: List[Dict]) -> List[str]:
        """
        –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
        
        Args:
            requests: –°–ø–∏—Å–æ–∫ –∑–∞–ø—Ä–æ—Å–æ–≤ [{"message": str, "history": List[Dict]}, ...]
        
        Returns:
            –°–ø–∏—Å–æ–∫ –æ—Ç–≤–µ—Ç–æ–≤
        """
        logger.info(f"üöÄ –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ {len(requests)} –∑–∞–ø—Ä–æ—Å–æ–≤")
        
        if not self.async_client:
            log_error(logger, "–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!")
            return ["–û—à–∏–±–∫–∞: –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"] * len(requests)
        
        # –°–æ–∑–¥–∞–µ–º –∑–∞–¥–∞—á–∏ –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
        tasks = []
        for request in requests:
            message = request.get("message", "")
            history = request.get("history", [])
            task = self.chat_async(message, history)
            tasks.append(task)
        
        try:
            # –í—ã–ø–æ–ª–Ω—è–µ–º –≤—Å–µ –∑–∞–¥–∞—á–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
            start_time = time.time()
            results = await asyncio.gather(*tasks, return_exceptions=True)
            elapsed_time = time.time() - start_time
            
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            processed_results = []
            for i, result in enumerate(results):
                if isinstance(result, Exception):
                    log_error(logger, f"–û—à–∏–±–∫–∞ –≤ –∑–∞–ø—Ä–æ—Å–µ {i+1}", error=result)
                    processed_results.append(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞: {str(result)}")
                else:
                    processed_results.append(result)
            
            log_success(logger, f"–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∑–∞ {elapsed_time:.2f}s", 
                       requests_count=len(requests),
                       avg_time_per_request=f"{elapsed_time/len(requests):.2f}s")
            
            return processed_results
            
        except Exception as e:
            log_error(logger, "–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ", error=e)
            return [f"–û—à–∏–±–∫–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏: {str(e)}"] * len(requests)
    
    def analyze_sme_trends(self, query: str = None) -> str:
        """
        –ê–Ω–∞–ª–∏–∑ –∏ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–µ–Ω–¥–æ–≤ –ú–°–ü
        
        Args:
            query: –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        
        Returns:
            –ê–Ω–∞–ª–∏–∑ –∏ –ø—Ä–æ–≥–Ω–æ–∑
        """
        try:
            prompt = """
–ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å –î–ï–¢–ê–õ–¨–ù–´–ô –∏ –°–¢–†–£–ö–¢–£–†–ò–†–û–í–ê–ù–ù–´–ô –∞–Ω–∞–ª–∏–∑ –∏ –ø—Ä–æ–≥–Ω–æ–∑ –¥–ª—è –º–∞–ª–æ–≥–æ –∏ —Å—Ä–µ–¥–Ω–µ–≥–æ –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –≤ –†–æ—Å—Å–∏–∏ –Ω–∞ —Ç–µ–∫—É—â–∏–π –ø–µ—Ä–∏–æ–¥.

–°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê:
1. –û–°–ù–û–í–ù–´–ï –¢–†–ï–ù–î–´ –í –ú–°–ü
   - –û–ø–∏—à–∏ 3-5 –∫–ª—é—á–µ–≤—ã—Ö —Ç—Ä–µ–Ω–¥–æ–≤ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –ø—Ä–∏–º–µ—Ä–∞–º–∏
   - –£–∫–∞–∂–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ —Ü–∏—Ñ—Ä—ã –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ
   - –û–±—ä—è—Å–Ω–∏ –ø—Ä–∏—á–∏–Ω—ã –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è —ç—Ç–∏—Ö —Ç—Ä–µ–Ω–¥–æ–≤

2. –ü–ï–†–°–ü–ï–ö–¢–ò–í–ù–´–ï –û–¢–†–ê–°–õ–ò
   - –ü–µ—Ä–µ—á–∏—Å–ª–∏ 5-7 –Ω–∞–∏–±–æ–ª–µ–µ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω—ã—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π
   - –û–±—ä—è—Å–Ω–∏ –ø–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ —ç—Ç–∏ –æ—Ç—Ä–∞—Å–ª–∏ —Ä–∞–∑–≤–∏–≤–∞—é—Ç—Å—è
   - –ü—Ä–∏–≤–µ–¥–∏ –¥–∞–Ω–Ω—ã–µ –æ —Ä–æ—Å—Ç–µ –∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–µ —ç—Ç–∏—Ö –æ—Ç—Ä–∞—Å–ª–µ–π

3. –ì–û–°–£–î–ê–†–°–¢–í–ï–ù–ù–ê–Ø –ü–û–î–î–ï–†–ñ–ö–ê
   - –ü–µ—Ä–µ—á–∏—Å–ª–∏ –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏
   - –£–∫–∞–∂–∏ —É—Å–ª–æ–≤–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏ —Ä–∞–∑–º–µ—Ä—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏
   - –û–ø–∏—à–∏ –º–µ—Ö–∞–Ω–∏–∑–º—ã —Ä–∞–±–æ—Ç—ã –ø—Ä–æ–≥—Ä–∞–º–º –ø–æ–¥–¥–µ—Ä–∂–∫–∏

4. –í–´–ó–û–í–´ –ò –†–ò–°–ö–ò
   - –û–ø–∏—à–∏ –æ—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –ú–°–ü
   - –û–±—ä—è—Å–Ω–∏ –ø—Ä–∏—á–∏–Ω—ã –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è —ç—Ç–∏—Ö –ø—Ä–æ–±–ª–µ–º
   - –ü—Ä–∏–≤–µ–¥–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –æ—Å–Ω–æ–≤–Ω—ã–º –≤—ã–∑–æ–≤–∞–º

5. –ê–ù–ê–õ–ò–¢–ò–ß–ï–°–ö–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø
   - –ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —Ä–∞–∑–≤–∏—Ç–∏—è –ú–°–ü
   - –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏ –ø–µ—Ä–∏–æ–¥–∞–º–∏
   - –†–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–∞–∑–≤–∏—Ç–∏—è

–ò—Å–ø–æ–ª—å–∑—É–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –ø–æ–¥–∞—á—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –ø—Ä–∏–≤–æ–¥–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –∏ —Ü–∏—Ñ—Ä—ã! –§–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–∏ –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –∞ –Ω–µ –Ω–∞ —Å–æ–≤–µ—Ç–∞—Ö.
"""
            if query:
                prompt += f"\n\n–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å: {query}"
            
            response = self.client.chat.completions.create(
                model=self.model,
                messages=[
                    {"role": "system", "content": "–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –º–∞–ª–æ–º—É –∏ —Å—Ä–µ–¥–Ω–µ–º—É –±–∏–∑–Ω–µ—Å—É –≤ –†–æ—Å—Å–∏–∏. –î–∞–≤–∞–π –ø–æ–¥—Ä–æ–±–Ω—ã–µ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã —Å –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –∏ —Ñ–∞–∫—Ç–∞–º–∏. –§–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –∞ –Ω–µ –Ω–∞ —Å–æ–≤–µ—Ç–∞—Ö."},
                    {"role": "user", "content": prompt}
                ],
                temperature=0.3,  # –ù–∏–∑–∫–∞—è –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤
                max_tokens=4000   # –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è –ø–æ–ª–Ω—ã—Ö –∞–Ω–∞–ª–∏–∑–æ–≤
            )
            
            return response.choices[0].message.content
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Ç—Ä–µ–Ω–¥–æ–≤ –ú–°–ü: {e}")
            return "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –∞–Ω–∞–ª–∏–∑–∞."
    
    def market_forecast(self, query: str = None) -> str:
        """
        –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä—ã–Ω–∫–∞ –¥–ª—è –ú–°–ü
        
        Args:
            query: –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        
        Returns:
            –ü—Ä–æ–≥–Ω–æ–∑ —Ä—ã–Ω–∫–∞
        """
        try:
            prompt = """
–ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å –î–ï–¢–ê–õ–¨–ù–´–ô –∏ –°–¢–†–£–ö–¢–£–†–ò–†–û–í–ê–ù–ù–´–ô –ø—Ä–æ–≥–Ω–æ–∑ —Ä—ã–Ω–∫–∞ –¥–ª—è –º–∞–ª–æ–≥–æ –∏ —Å—Ä–µ–¥–Ω–µ–≥–æ –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –≤ –†–æ—Å—Å–∏–∏.

–°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê:
1. –¢–ï–ö–£–©–ï–ï –°–û–°–¢–û–Ø–ù–ò–ï –†–´–ù–ö–ê
   - –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —Ä—ã–Ω–∫–∞ –ú–°–ü
   - –ö–ª—é—á–µ–≤—ã–µ –∏–≥—Ä–æ–∫–∏ –∏ –∏—Ö –¥–æ–ª—è
   - –†–µ–≥–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ

2. –§–ê–ö–¢–û–†–´ –í–õ–ò–Ø–ù–ò–Ø –ù–ê –†–´–ù–û–ö
   - –≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ —Ñ–∞–∫—Ç–æ—Ä—ã
   - –ü–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏ —Ä–µ–≥—É–ª—è—Ç–æ—Ä–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
   - –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–Ω–¥—ã
   - –°–æ—Ü–∏–∞–ª—å–Ω—ã–µ –∏ –¥–µ–º–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ —Ñ–∞–∫—Ç–æ—Ä—ã

3. –ü–†–û–ì–ù–û–ó –†–ê–ó–í–ò–¢–ò–Ø
   - –ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑ (6-12 –º–µ—Å—è—Ü–µ–≤)
   - –°—Ä–µ–¥–Ω–µ—Å—Ä–æ—á–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑ (1-3 –≥–æ–¥–∞)
   - –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑ (3-5 –ª–µ—Ç)

4. –°–ï–ì–ú–ï–ù–¢–ê–¶–ò–Ø –†–´–ù–ö–ê
   - –ê–Ω–∞–ª–∏–∑ –ø–æ –æ—Ç—Ä–∞—Å–ª—è–º
   - –ê–Ω–∞–ª–∏–∑ –ø–æ —Ä–∞–∑–º–µ—Ä–∞–º –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π
   - –ê–Ω–∞–ª–∏–∑ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º

5. –ö–õ–Æ–ß–ï–í–´–ï –ú–ï–¢–†–ò–ö–ò –ò –ü–û–ö–ê–ó–ê–¢–ï–õ–ò
   - –û–∂–∏–¥–∞–µ–º—ã–µ —Ç–µ–º–ø—ã —Ä–æ—Å—Ç–∞
   - –û–±—ä–µ–º—ã —Ä—ã–Ω–∫–∞
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π
   - –ó–∞–Ω—è—Ç–æ—Å—Ç—å –≤ —Å–µ–∫—Ç–æ—Ä–µ

–ò—Å–ø–æ–ª—å–∑—É–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –ø–æ–¥–∞—á—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –ø—Ä–∏–≤–æ–¥–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É! –§–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–∏ –ø–æ–¥—Ä–æ–±–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.
"""
            if query:
                prompt += f"\n\n–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å: {query}"
            
            response = self.client.chat.completions.create(
                model=self.model,
                messages=[
                    {"role": "system", "content": "–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ä—ã–Ω–æ—á–Ω–æ–º—É –∞–Ω–∞–ª–∏–∑—É –∏ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—é –≤ —Å—Ñ–µ—Ä–µ –ú–°–ü –†–æ—Å—Å–∏–∏. –î–∞–≤–∞–π –ø–æ–¥—Ä–æ–±–Ω—ã–µ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ–≥–Ω–æ–∑—ã —Å –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –∏ —Ñ–∞–∫—Ç–∞–º–∏. –§–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –∞ –Ω–µ –Ω–∞ —Å–æ–≤–µ—Ç–∞—Ö."},
                    {"role": "user", "content": prompt}
                ],
                temperature=0.3,  # –ù–∏–∑–∫–∞—è –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤
                max_tokens=4000   # –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è –ø–æ–ª–Ω—ã—Ö –ø—Ä–æ–≥–Ω–æ–∑–æ–≤
            )
            
            return response.choices[0].message.content
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è —Ä—ã–Ω–∫–∞: {e}")
            return "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø—Ä–æ–≥–Ω–æ–∑–∞ —Ä—ã–Ω–∫–∞."
    
    def business_insights(self, query: str = None) -> str:
        """
        –ë–∏–∑–Ω–µ—Å-–∏–Ω—Å–∞–π—Ç—ã –¥–ª—è –ú–°–ü
        
        Args:
            query: –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        
        Returns:
            –ë–∏–∑–Ω–µ—Å-–∏–Ω—Å–∞–π—Ç—ã
        """
        try:
            prompt = """
–ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å –î–ï–¢–ê–õ–¨–ù–´–ô –∏ –°–¢–†–£–ö–¢–£–†–ò–†–û–í–ê–ù–ù–´–ô –∞–Ω–∞–ª–∏–∑ –±–∏–∑–Ω–µ—Å-–∏–Ω—Å–∞–π—Ç–æ–≤ –¥–ª—è –º–∞–ª–æ–≥–æ –∏ —Å—Ä–µ–¥–Ω–µ–≥–æ –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –≤ –†–æ—Å—Å–∏–∏.

–°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê:
1. –ö–õ–Æ–ß–ï–í–´–ï –ò–ù–°–ê–ô–¢–´ –û–¢–†–ê–°–õ–ò
   - –í–∞–∂–Ω—ã–µ –æ—Ç–∫—Ä—ã—Ç–∏—è –∏ —Ç–µ–Ω–¥–µ–Ω—Ü–∏–∏
   - –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ø–æ–≤–µ–¥–µ–Ω–∏–∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π
   - –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –Ω–∞ —Ä—ã–Ω–∫–µ

2. –¢–ï–•–ù–û–õ–û–ì–ò–ß–ï–°–ö–ò–ï –ò–ù–ù–û–í–ê–¶–ò–ò
   - –í–Ω–µ–¥—Ä–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π –≤ –ú–°–ü
   - –¶–∏—Ñ—Ä–æ–≤–∏–∑–∞—Ü–∏—è –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤
   - –í–ª–∏—è–Ω–∏–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π –Ω–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å

3. –ò–ó–ú–ï–ù–ï–ù–ò–Ø –í –ü–û–¢–†–ï–ë–ò–¢–ï–õ–¨–°–ö–û–ú –ü–û–í–ï–î–ï–ù–ò–ò
   - –ù–æ–≤—ã–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤
   - –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å–ø–æ—Å–æ–±–∞—Ö –ø–æ–∫—É–ø–∫–∏
   - –í–ª–∏—è–Ω–∏–µ —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤

4. –ö–û–ù–ö–£–†–ï–ù–¢–ù–ê–Ø –°–†–ï–î–ê
   - –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏
   - –ù–æ–≤—ã–µ –∏–≥—Ä–æ–∫–∏ –Ω–∞ —Ä—ã–Ω–∫–µ
   - –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤

5. –†–ï–ì–£–õ–Ø–¢–ò–í–ù–´–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø
   - –ù–æ–≤—ã–µ –∑–∞–∫–æ–Ω—ã –∏ –ø–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
   - –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –Ω–∞–ª–æ–≥–æ–æ–±–ª–æ–∂–µ–Ω–∏–∏
   - –í–ª–∏—è–Ω–∏–µ —Ä–µ–≥—É–ª—è—Ç–æ—Ä–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞ –±–∏–∑–Ω–µ—Å

6. –≠–ö–û–ù–û–ú–ò–ß–ï–°–ö–ò–ï –ò–ù–î–ò–ö–ê–¢–û–†–´
   - –ö–ª—é—á–µ–≤—ã–µ —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
   - –í–ª–∏—è–Ω–∏–µ –º–∞–∫—Ä–æ—ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤
   - –ü—Ä–æ–≥–Ω–æ–∑—ã —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è

–ò—Å–ø–æ–ª—å–∑—É–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –ø–æ–¥–∞—á—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –ø—Ä–∏–≤–æ–¥–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –∏ –¥–∞–Ω–Ω—ã–µ! –§–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–∏ –ø–æ–¥—Ä–æ–±–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.
"""
            if query:
                prompt += f"\n\n–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å: {query}"
            
            response = self.client.chat.completions.create(
                model=self.model,
                messages=[
                    {"role": "system", "content": "–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –±–∏–∑–Ω–µ—Å-–∞–Ω–∞–ª–∏—Ç–∏–∫–µ –∏ –∏–Ω—Å–∞–π—Ç–∞–º –≤ —Å—Ñ–µ—Ä–µ –ú–°–ü –†–æ—Å—Å–∏–∏. –î–∞–≤–∞–π –ø–æ–¥—Ä–æ–±–Ω—ã–µ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑—ã —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –∏ —Ñ–∞–∫—Ç–∞–º–∏. –§–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –∞ –Ω–µ –Ω–∞ —Å–æ–≤–µ—Ç–∞—Ö."},
                    {"role": "user", "content": prompt}
                ],
                temperature=0.3,  # –ù–∏–∑–∫–∞—è –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤
                max_tokens=4000   # –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è –ø–æ–ª–Ω—ã—Ö –∏–Ω—Å–∞–π—Ç–æ–≤
            )
            
            return response.choices[0].message.content
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –±–∏–∑–Ω–µ—Å-–∏–Ω—Å–∞–π—Ç–æ–≤: {e}")
            return "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –±–∏–∑–Ω–µ—Å-–∏–Ω—Å–∞–π—Ç–æ–≤."
    
    def analyze_feedback(self, feedback_list: List[str]) -> str:
        """
        –ê–Ω–∞–ª–∏–∑ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        
        Args:
            feedback_list: –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏
        
        Returns:
            –°–≤–æ–¥–Ω—ã–π –∞–Ω–∞–ª–∏–∑
        """
        try:
            feedback_text = "\n".join([f"- {fb}" for fb in feedback_list])
            
            prompt = f"""
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ª–µ–¥—É—é—â—É—é –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Å–æ–∑–¥–∞–π —Å–≤–æ–¥–Ω—ã–π –æ—Ç—á–µ—Ç:

{feedback_text}

–í—ã–¥–µ–ª–∏:
1. –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ–º—ã –∏ –≤–æ–ø—Ä–æ—Å—ã
2. –ß–∞—Å—Ç—ã–µ –∂–∞–ª–æ–±—ã –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã
3. –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ —É–ª—É—á—à–µ–Ω–∏—é
4. –û–±—â–∏–µ –≤—ã–≤–æ–¥—ã
"""
            
            response = self.client.chat.completions.create(
                model=self.model,
                messages=[
                    {"role": "system", "content": "–¢—ã - –∞–Ω–∞–ª–∏—Ç–∏–∫ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤."},
                    {"role": "user", "content": prompt}
                ],
                temperature=0.3,  # –ù–∏–∑–∫–∞—è –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
                max_tokens=500    # –£–º–µ–Ω—å—à–µ–Ω–æ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
            )
            
            return response.choices[0].message.content
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏: {e}")
            return "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏."
    
    def extract_user_info(self, conversation: str) -> Dict:
        """
        –ò–∑–≤–ª–µ—á—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –∏–∑ –¥–∏–∞–ª–æ–≥–∞
        
        Args:
            conversation: –¢–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞
        
        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        """
        try:
            prompt = f"""
–ò–∑–≤–ª–µ–∫–∏ –∏–∑ —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–∏–∞–ª–æ–≥–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ:

{conversation}

–í–µ—Ä–Ω–∏ JSON —Å –ø–æ–ª—è–º–∏: full_name, email, phone, organization, position.
–ï—Å–ª–∏ –∫–∞–∫–æ–µ-—Ç–æ –ø–æ–ª–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, —É–∫–∞–∂–∏ null.
"""
            
            response = self.client.chat.completions.create(
                model=self.model,
                messages=[
                    {"role": "system", "content": "–¢—ã –∏–∑–≤–ª–µ–∫–∞–µ—à—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–µ–∫—Å—Ç–∞."},
                    {"role": "user", "content": prompt}
                ],
                temperature=1.0,  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å
                max_tokens=4000,  # –£–≤–µ–ª–∏—á–µ–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ
                response_format={"type": "json_object"}
            )
            
            import json
            return json.loads(response.choices[0].message.content)
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö: {e}")
            return {}

    def detect_intent_and_extract(self, conversation: str) -> Dict:
        """
        –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∏–∑–≤–ª–µ—á—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON –≤–∏–¥–∞:
        {
          "intent": "application|document|feedback|none",
          "application": {"full_name": ..., "email": ..., "phone": ..., "organization": ..., "inn": ..., "business_type": ..., "comment": ...},
          "document": {"template_type": "complaint|protocol|contract", "user_data": {...}},
          "feedback": {"message": ..., "category": ...}
        }
        –ü–æ–ª—è, –Ω–µ –æ—Ç–Ω–æ—Å—è—â–∏–µ—Å—è –∫ –Ω–∞–º–µ—Ä–µ–Ω–∏—é, –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å null/–ø—É—Å—Ç—ã–º–∏ –æ–±—ä–µ–∫—Ç–∞–º–∏.
        """
        try:
            prompt = f"""
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –¥–∏–∞–ª–æ–≥ –∏ –æ–ø—Ä–µ–¥–µ–ª–∏ –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
- –ï—Å–ª–∏ —Ö–æ—á–µ—Ç –ø–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ, intent = application.
- –ï—Å–ª–∏ –ø—Ä–æ—Å–∏—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç (–∂–∞–ª–æ–±–∞/–ø—Ä–æ—Ç–æ–∫–æ–ª/–¥–æ–≥–æ–≤–æ—Ä), intent = document.
- –ï—Å–ª–∏ –æ—Å—Ç–∞–≤–ª—è–µ—Ç –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å, intent = feedback.
- –ò–Ω–∞—á–µ intent = none.

–î–∏–∞–ª–æ–≥:
{conversation}

–í–µ—Ä–Ω–∏ JSON —Å—Ç—Ä–æ–≥–æ –ø–æ —Å—Ö–µ–º–µ:
{{
  "intent": "application|document|feedback|none",
  "application": {{
    "full_name": null|string,
    "email": null|string,
    "phone": null|string,
    "organization": null|string,
    "inn": null|string,
    "business_type": null|string,
    "comment": null|string
  }},
  "document": {{
    "template_type": null|"complaint"|"protocol"|"contract",
    "user_data": null|object
  }},
  "feedback": {{
    "message": null|string,
    "category": null|string
  }}
}}
"""

            response = self.client.chat.completions.create(
                model=self.model,
                messages=[
                    {"role": "system", "content": "–¢—ã –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ—à—å –Ω–∞–º–µ—Ä–µ–Ω–∏—è –∏ –∏–∑–≤–ª–µ–∫–∞–µ—à—å –¥–∞–Ω–Ω—ã–µ, –æ—Ç–≤–µ—á–∞–µ—à—å —Å—Ç—Ä–æ–≥–æ JSON."},
                    {"role": "user", "content": prompt}
                ],
                temperature=1.0,  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å
                max_tokens=4000,  # –£–≤–µ–ª–∏—á–µ–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ
                response_format={"type": "json_object"}
            )

            import json
            return json.loads(response.choices[0].message.content)
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞–º–µ—Ä–µ–Ω–∏—è: {e}")
            return {"intent": "none"}
    
    def analyze_document_data_completeness(self, user_data: Dict, 
                                          required_fields: List[str],
                                          conversation_history: str = "") -> Dict:
        """
        –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø–æ–ª–Ω–æ—Ç—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞
        
        Args:
            user_data: –°–æ–±—Ä–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            required_fields: –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞
            conversation_history: –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        
        Returns:
            –ê–Ω–∞–ª–∏–∑ –ø–æ–ª–Ω–æ—Ç—ã –¥–∞–Ω–Ω—ã—Ö —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏
        """
        try:
            prompt = f"""
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø–æ–ª–Ω–æ—Ç—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞.

–°–æ–±—Ä–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
{user_data}

–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è:
{required_fields}

–ö–æ–Ω—Ç–µ–∫—Å—Ç –±–µ—Å–µ–¥—ã:
{conversation_history}

–í–µ—Ä–Ω–∏ JSON —Å –∞–Ω–∞–ª–∏–∑–æ–º:
{{
  "completeness_score": 0-100,
  "filled_fields": ["—Å–ø–∏—Å–æ–∫ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –ø–æ–ª–µ–π"],
  "missing_fields": ["—Å–ø–∏—Å–æ–∫ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö –ø–æ–ª–µ–π"],
  "confidence_score": 0-100,
  "data_quality": "excellent|good|fair|poor",
  "recommendations": ["—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é"],
  "can_generate": true|false,
  "suggested_questions": ["–≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö"]
}}
"""

            response = self.client.chat.completions.create(
                model=self.model,
                messages=[
                    {"role": "system", "content": "–¢—ã –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—à—å –ø–æ–ª–Ω–æ—Ç—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤."},
                    {"role": "user", "content": prompt}
                ],
                temperature=1.0,  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å
                max_tokens=4000,  # –£–≤–µ–ª–∏—á–µ–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ
                response_format={"type": "json_object"}
            )

            import json
            return json.loads(response.choices[0].message.content)
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –ø–æ–ª–Ω–æ—Ç—ã –¥–∞–Ω–Ω—ã—Ö: {e}")
            return {
                "completeness_score": 0,
                "filled_fields": [],
                "missing_fields": required_fields,
                "confidence_score": 0,
                "data_quality": "poor",
                "recommendations": ["–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–±—Ä–∞—Ç—å –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ"],
                "can_generate": False,
                "suggested_questions": []
            }
    
    def classify_document_type(self, conversation: str, 
                              available_templates: List[Dict]) -> Dict:
        """
        –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –±–µ—Å–µ–¥—ã
        
        Args:
            conversation: –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞
            available_templates: –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤
        
        Returns:
            –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –≤—ã–±–æ—Ä—É —à–∞–±–ª–æ–Ω–∞
        """
        try:
            templates_info = "\n".join([
                f"- {t.get('name', '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')} (ID: {t.get('template_id', 'unknown')}): {t.get('description', '')}"
                for t in available_templates
            ])
            
            prompt = f"""
–û–ø—Ä–µ–¥–µ–ª–∏ –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –±–µ—Å–µ–¥—ã.

–î–∏–∞–ª–æ–≥:
{conversation}

–î–æ—Å—Ç—É–ø–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã:
{templates_info}

–í–µ—Ä–Ω–∏ JSON —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏:
{{
  "suggested_template_id": "id —à–∞–±–ª–æ–Ω–∞",
  "suggested_template_name": "–Ω–∞–∑–≤–∞–Ω–∏–µ",
  "confidence": 0-100,
  "reasoning": "–æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞",
  "alternative_templates": ["—Å–ø–∏—Å–æ–∫ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö ID"],
  "document_category": "–∑–∞—è–≤–ª–µ–Ω–∏–µ|–∞–Ω–∫–µ—Ç–∞|–¥–æ–≥–æ–≤–æ—Ä|–∂–∞–ª–æ–±–∞|–æ—Ç—á–µ—Ç|—Å–ø—Ä–∞–≤–∫–∞|–ø—Ä–æ—Ç–æ–∫–æ–ª|–¥—Ä—É–≥–æ–µ"
}}
"""

            response = self.client.chat.completions.create(
                model=self.model,
                messages=[
                    {"role": "system", "content": "–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –≤—ã–±–æ—Ä—É –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —à–∞–±–ª–æ–Ω–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤."},
                    {"role": "user", "content": prompt}
                ],
                temperature=1.0,  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å
                max_tokens=4000,  # –£–≤–µ–ª–∏—á–µ–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ
                response_format={"type": "json_object"}
            )

            import json
            return json.loads(response.choices[0].message.content)
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Ç–∏–ø–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞: {e}")
            return {
                "suggested_template_id": None,
                "suggested_template_name": None,
                "confidence": 0,
                "reasoning": "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞",
                "alternative_templates": [],
                "document_category": "–¥—Ä—É–≥–æ–µ"
            }
    
    def extract_structured_data_advanced(self, conversation: str, 
                                        template_fields: List[str]) -> Dict:
        """
        –†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å —É—á–µ—Ç–æ–º —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏—Ö –ø–æ–ª–µ–π —à–∞–±–ª–æ–Ω–∞
        
        Args:
            conversation: –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞
            template_fields: –°–ø–∏—Å–æ–∫ –ø–æ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –∏–∑–≤–ª–µ—á—å
        
        Returns:
            –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å –º–µ—Ç–∞–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
        """
        try:
            fields_list = ", ".join(template_fields)
            
            prompt = f"""
–ò–∑–≤–ª–µ–∫–∏ –∏–∑ –¥–∏–∞–ª–æ–≥–∞ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö –ø–æ–ª–µ–π: {fields_list}

–í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê –°–û–ü–û–°–¢–ê–í–õ–ï–ù–ò–Ø:
- –ï—Å–ª–∏ –µ—Å—Ç—å "–§–∞–º–∏–ª–∏—è", "–ò–º—è", "–û—Ç—á–µ—Å—Ç–≤–æ" ‚Üí –æ–±—ä–µ–¥–∏–Ω–∏ –≤ "full_name" –∫–∞–∫ "–§–∞–º–∏–ª–∏—è –ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ"
- –ï—Å–ª–∏ –µ—Å—Ç—å "last_name", "first_name", "middle_name" ‚Üí –∏—Å–ø–æ–ª—å–∑—É–π –ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ—Å—Ç–∏
- "–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è" ‚Üí "birth_date"
- "–¢–µ–ª–µ—Ñ–æ–Ω" ‚Üí "phone"
- "Email" –∏–ª–∏ "–≠–ª.–ø–æ—á—Ç–∞" ‚Üí "email"
- "–î–∞–Ω–Ω—ã–µ –ø–∞—Å–ø–æ—Ä—Ç–∞" –∏–ª–∏ "–ü–∞—Å–ø–æ—Ä—Ç" ‚Üí "passport"
- "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞–±–æ—Ç–µ" –∏–ª–∏ "–†–∞–±–æ—Ç–∞" ‚Üí "work_info"
- "–°—Ñ–µ—Ä–∞ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏" –∏–ª–∏ "–°—Ñ–µ—Ä–∞" ‚Üí "activity_sphere"
- "–ü—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç" –∏–ª–∏ "–û–ø—ã—Ç" ‚Üí "business_experience"
- "–û–±–ª–∞—Å—Ç—å –≥–¥–µ –≤—ã —ç–∫—Å–ø–µ—Ä—Ç" –∏–ª–∏ "–≠–∫—Å–ø–µ—Ä—Ç–∏–∑–∞" ‚Üí "expertise_area"
- "–ó–∞–Ω–∏–º–∞–ª–∏ –ª–∏ –≤—ã –≤—ã–±–æ—Ä–Ω—É—é –¥–æ–ª–∂–Ω–æ—Å—Ç—å" ‚Üí "elected_position"
- "–û–ø—ã—Ç –æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏" –∏–ª–∏ "–û–±—â–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å" ‚Üí "public_activity_experience"
- "–î–æ–ø–æ–ª–Ω–µ–Ω–∏—è" ‚Üí "additional_info"

–î–∏–∞–ª–æ–≥:
{conversation}

–í–µ—Ä–Ω–∏ JSON —Å –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏ –º–µ—Ç–∞–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π:
{{
  "extracted_data": {{
    "field_name": {{"value": "–∑–Ω–∞—á–µ–Ω–∏–µ", "confidence": 0-100, "source": "–æ—Ç–∫—É–¥–∞ –≤–∑—è—Ç–æ"}}
  }},
  "overall_confidence": 0-100,
  "ambiguous_fields": ["–ø–æ–ª—è —Å –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏"],
  "inferred_fields": ["–ø–æ–ª—è, –∑–Ω–∞—á–µ–Ω–∏—è –∫–æ—Ç–æ—Ä—ã—Ö –±—ã–ª–∏ –≤—ã–≤–µ–¥–µ–Ω—ã –ª–æ–≥–∏—á–µ—Å–∫–∏"],
  "missing_fields": ["–ø–æ–ª—è, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å"]
}}

–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏–∑–≤–ª–µ–∫–∏ –í–°–ï –ø–æ–ª—è, –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å –≤ –¥–∏–∞–ª–æ–≥–µ, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω–∏ –Ω–∞–∑—ã–≤–∞—é—Ç—Å—è –ø–æ-–¥—Ä—É–≥–æ–º—É!
"""

            response = self.client.chat.completions.create(
                model=self.model,
                messages=[
                    {"role": "system", "content": "–¢—ã –∏–∑–≤–ª–µ–∫–∞–µ—à—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å –≤—ã—Å–æ–∫–æ–π —Ç–æ—á–Ω–æ—Å—Ç—å—é."},
                    {"role": "user", "content": prompt}
                ],
                temperature=1.0,  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å
                max_tokens=4000,  # –£–≤–µ–ª–∏—á–µ–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ
                response_format={"type": "json_object"}
            )

            import json
            return json.loads(response.choices[0].message.content)
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö: {e}")
            return {
                "extracted_data": {},
                "overall_confidence": 0,
                "ambiguous_fields": [],
                "inferred_fields": [],
                "missing_fields": template_fields
            }
    
    def generate_document_preview(self, template_name: str, 
                                 user_data: Dict) -> str:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞
        
        Args:
            template_name: –ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞
            user_data: –î–∞–Ω–Ω—ã–µ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
        
        Returns:
            –¢–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≥–æ, –∫–∞–∫ –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç
        """
        try:
            prompt = f"""
–°–æ–∑–¥–∞–π —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ "{template_name}" —Å –¥–∞–Ω–Ω—ã–º–∏:

{user_data}

–û–ø–∏—à–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏ –∫–∞–∫ –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –ø–æ–ª—è. –í—ã–¥–µ–ª–∏ –ø–æ–ª—è, –∫–æ—Ç–æ—Ä—ã–µ –æ—Å—Ç–∞–ª–∏—Å—å –ø—É—Å—Ç—ã–º–∏.
"""

            response = self.client.chat.completions.create(
                model=self.model,
                messages=[
                    {"role": "system", "content": "–¢—ã —Å–æ–∑–¥–∞–µ—à—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤."},
                    {"role": "user", "content": prompt}
                ],
                temperature=0.3,  # –ù–∏–∑–∫–∞—è –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
                max_tokens=1000   # –£–º–µ–Ω—å—à–µ–Ω–æ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
            )

            return response.choices[0].message.content
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞: {e}")
            return "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞."
    
    def chat_with_extraction(self, message: str, conversation_history: List[Dict] = None) -> tuple:
        """
        –û–ë–™–ï–î–ò–ù–ï–ù–ù–´–ô –ú–ï–¢–û–î: —á–∞—Ç + –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö + –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–º–µ—Ä–µ–Ω–∏—è
        –≠—Ç–æ –∑–∞–º–µ–Ω—è–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ API –≤—ã–∑–æ–≤—ã –æ–¥–Ω–∏–º –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∑–∞–ø—Ä–æ—Å–æ–º
        
        Args:
            message: –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            conversation_history: –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞
        
        Returns:
            tuple: (response_text, user_data, intent_data)
        """
        logger.info("ü§ñ –û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å: —á–∞—Ç + –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö + –Ω–∞–º–µ—Ä–µ–Ω–∏–µ")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –∫–ª–∏–µ–Ω—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω
        if not self.client:
            log_error(logger, "OpenAI –∫–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω! API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
            return "–ò–∑–≤–∏–Ω–∏—Ç–µ, OpenAI/DeepSeek API –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Å–µ—Ä–≤–µ—Ä–∞.", {}, {}
        
        try:
            # –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –≤—Å–µ—Ö –∑–∞–¥–∞—á
            conversation_text = ""
            if conversation_history:
                recent_history = conversation_history[-3:]  # –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 —Å–æ–æ–±—â–µ–Ω–∏—è
                conversation_text = "\n".join([f"{msg.get('role', 'user')}: {msg.get('content', '')}" for msg in recent_history])
            
            combined_prompt = f"""
–û–±—Ä–∞–±–æ—Ç–∞–π —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≤—ã–ø–æ–ª–Ω–∏ —Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–¥–∞—á–∏:

1. –û–¢–í–ï–¢–¨ –Ω–∞ –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ü–û–î–†–û–ë–ù–û –∏ –ü–û–õ–ï–ó–ù–û
2. –ò–ó–í–õ–ï–ö–ò –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –æ–Ω–∏ —è–≤–Ω–æ —É–∫–∞–∑–∞–Ω—ã
3. –û–ü–†–ï–î–ï–õ–ò –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–ü–†–ò–ù–¶–ò–ü–´ –û–¢–í–ï–¢–ê:
- –î–∞–≤–∞–π –†–ê–ó–í–ï–†–ù–£–¢–´–ï –æ—Ç–≤–µ—Ç—ã —Å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–º–∏ —Å–æ–≤–µ—Ç–∞–º–∏
- –ò—Å–ø–æ–ª—å–∑—É–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –ø–æ–¥–∞—á—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (—Å–ø–∏—Å–∫–∏, —Ä–∞–∑–¥–µ–ª—ã)
- –ü—Ä–∏–≤–æ–¥–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –∏ –ø–æ—à–∞–≥–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
- –ü—Ä–µ–¥–ª–∞–≥–∞–π –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø–æ–º–æ—â–∏
- –ò—Å–ø–æ–ª—å–∑—É–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –ø–æ–¥–∞—á—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
- –ê–¥–∞–ø—Ç–∏—Ä—É–π —Å–ª–æ–∂–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ–¥ —É—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–í–ê–ñ–ù–´–ï –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø: 
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å—Ç–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏–ª—Å—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ú–µ–Ω—è –∑–æ–≤—É—Ç –õ–µ–≤"), –æ—Ç–≤–µ—á–∞–π –¥—Ä—É–∂–µ–ª—é–±–Ω–æ –∫–∞–∫ –æ–±—ã—á–Ω—ã–π —á–∞—Ç
- –ù–ï –ø—Ä–µ–¥–ª–∞–≥–∞–π —Å–æ–∑–¥–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –±–µ–∑ —è–≤–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
- –ù–ï –∏–∑–≤–ª–µ–∫–∞–π –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–æ—Å—Ç—ã—Ö –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π –∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π
- –î–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π –∏—Å–ø–æ–ª—å–∑—É–π intent = "chat"

–¢–ò–ü–´ –ó–ê–ü–†–û–°–û–í –ò –ü–û–î–•–û–î–´:
- –í–æ–ø—Ä–æ—Å—ã –æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –±–∏–∑–Ω–µ—Å–∞: –ø–æ–¥—Ä–æ–±–Ω–æ –æ–±—ä—è—Å–Ω–∏ —ç—Ç–∞–ø—ã, –¥–æ–∫—É–º–µ–Ω—Ç—ã, —Å—Ä–æ–∫–∏, —Å—Ç–æ–∏–º–æ—Å—Ç—å
- –ó–∞–ø—Ä–æ—Å—ã –æ –ª—å–≥–æ—Ç–∞—Ö –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–µ: –ø–µ—Ä–µ—á–∏—Å–ª–∏ –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã —Å —É—Å–ª–æ–≤–∏—è–º–∏
- –í–æ–ø—Ä–æ—Å—ã –æ —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–∏: –æ–ø–∏—à–∏ –≤—Å–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏
- –ó–∞–ø—Ä–æ—Å—ã –æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö: –ø—Ä–µ–¥–ª–æ–∂–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ —à–∞–±–ª–æ–Ω—ã —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
- –ü—Ä–∞–≤–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã: –¥–∞–π —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏
- –ë–∏–∑–Ω–µ—Å-–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏: –ø—Ä–µ–¥–ª–æ–∂–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —à–∞–≥–∏ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

–°–æ–æ–±—â–µ–Ω–∏–µ: {message}

–ö–æ–Ω—Ç–µ–∫—Å—Ç –±–µ—Å–µ–¥—ã:
{conversation_text}

–í–µ—Ä–Ω–∏ –æ—Ç–≤–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
{{
  "response": "—Ç–≤–æ–π –ü–û–î–†–û–ë–ù–´–ô –∏ –ü–û–õ–ï–ó–ù–´–ô –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–º–∏ —Å–æ–≤–µ—Ç–∞–º–∏. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–∞–≤–∞–π –ü–û–õ–ù–´–ô –æ—Ç–≤–µ—Ç –±–µ–∑ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–π –∏ –æ–±—Ä–µ–∑–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞!",
  "user_data": {{
    "full_name": "–∏–º—è –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —è–≤–Ω–æ —É–∫–∞–∑–∞–Ω–æ",
    "email": "email –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —è–≤–Ω–æ —É–∫–∞–∑–∞–Ω", 
    "phone": "—Ç–µ–ª–µ—Ñ–æ–Ω –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —è–≤–Ω–æ —É–∫–∞–∑–∞–Ω",
    "organization": "–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —è–≤–Ω–æ —É–∫–∞–∑–∞–Ω–∞",
    "position": "–¥–æ–ª–∂–Ω–æ—Å—Ç—å –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —è–≤–Ω–æ —É–∫–∞–∑–∞–Ω–∞"
  }},
  "intent": {{
    "type": "application|document|feedback|chat",
    "confidence": 0-100,
    "details": "–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ –Ω–∞–º–µ—Ä–µ–Ω–∏—è"
  }}
}}

–ü–æ–º–Ω–∏: —Ç–≤–æ—è —Ü–µ–ª—å - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–º–æ—á—å –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—é! –î–∞–≤–∞–π —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–µ, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã —Å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–π –ø–æ–ª—å–∑–æ–π! –í–ê–ñ–ù–û: –≤—Å–µ–≥–¥–∞ –¥–∞–≤–∞–π –ü–û–õ–ù–´–ï –æ—Ç–≤–µ—Ç—ã –±–µ–∑ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–π –∏ –æ–±—Ä–µ–∑–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞!
"""

            response = self.client.chat.completions.create(
                model=self.model,
                messages=[
                    {"role": "system", "content": "–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç '–û–ø–æ—Ä–∞ –†–æ—Å—Å–∏–∏' –¥–ª—è –ú–°–ü. –î–∞–≤–∞–π –ü–û–î–†–û–ë–ù–´–ï –∏ –ü–û–õ–ï–ó–ù–´–ï –æ—Ç–≤–µ—Ç—ã —Å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–º–∏ —Å–æ–≤–µ—Ç–∞–º–∏. –ü–æ–º–æ–≥–∞–π —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏, –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ–º, –±–∏–∑–Ω–µ—Å-–≤–æ–ø—Ä–æ—Å–∞–º–∏, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π, –ª—å–≥–æ—Ç–∞–º–∏ –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π. –ò—Å–ø–æ–ª—å–∑—É–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –ø–æ–¥–∞—á—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã. –ù–ï –ø—Ä–µ–¥–ª–∞–≥–∞–π —Å–æ–∑–¥–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –±–µ–∑ —è–≤–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –í—Å–µ–≥–¥–∞ –¥–∞–≤–∞–π –ü–û–õ–ù–´–ï –æ—Ç–≤–µ—Ç—ã –±–µ–∑ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–π!"},
                    {"role": "user", "content": combined_prompt}
                ],
                temperature=0.5,  # –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å
                max_tokens=4000,  # –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è –ø–æ–ª–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
                timeout=60.0      # –£–≤–µ–ª–∏—á–µ–Ω —Ç–∞–π–º–∞—É—Ç –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
            )
            
            result = response.choices[0].message.content
            
            # –ü–∞—Ä—Å–∏–º JSON –æ—Ç–≤–µ—Ç
            try:
                import json
                parsed_result = json.loads(result)
                response_text = parsed_result.get("response", result)
                user_data = parsed_result.get("user_data", {})
                intent_data = parsed_result.get("intent", {})
            except:
                # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
                response_text = result
                user_data = {}
                intent_data = {}
            
            log_success(logger, f"–û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω", 
                       response_length=len(response_text),
                       user_data_fields=len(user_data),
                       intent_type=intent_data.get("type", "unknown"))
            
            return response_text, user_data, intent_data
            
        except Exception as e:
            log_error(logger, "–û—à–∏–±–∫–∞ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞", error=e)
            return f"–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞: {str(e)}", {}, {}


# Singleton instance
openai_service = OpenAIService()

